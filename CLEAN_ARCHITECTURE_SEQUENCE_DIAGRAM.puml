@startuml Clean Architecture Sequence Diagram
!theme plain
title Clean Architecture Sequence Diagram - Customer Evaluation Flow

note top
  ğŸ“š HÆ¯á»šNG DáºªN CHO NGÆ¯á»œI Má»šI:
  ============================
  
  Sequence Diagram nÃ y mÃ´ táº£ flow xá»­ lÃ½ cá»¥ thá»ƒ khi user Ä‘Ã¡nh giÃ¡ khÃ¡ch hÃ ng:
  
  ğŸ¯ SCENARIO: User cháº¡y CLI Ä‘á»ƒ Ä‘Ã¡nh giÃ¡ khÃ¡ch hÃ ng CUST001 trong chÆ°Æ¡ng trÃ¬nh PROG001
  
  ğŸ”„ FLOW:
  1. User tÆ°Æ¡ng tÃ¡c vá»›i CLI
  2. CLI gá»i Use Case
  3. Use Case gá»i Domain Service
  4. Domain Service sá»­ dá»¥ng Repository Interfaces
  5. Repository Implementations truy cáº­p Database
  6. Káº¿t quáº£ tráº£ vá» theo thá»© tá»± ngÆ°á»£c láº¡i
  
  ğŸ“ LÆ¯U Ã: Má»—i arrow Ä‘áº¡i diá»‡n cho má»™t method call
end note

actor "ğŸ‘¤ User" as User
participant "ğŸ–¥ï¸ EvaluationCLI" as CLI
participant "ğŸ“‹ EvaluateCustomerUseCase" as UseCase
participant "ğŸ§  EvaluationService" as DomainService
participant "ğŸ“Š EvaluationRepository" as EvaluationRepo
participant "ğŸ“ RegistrationRepository" as RegistrationRepo
participant "ğŸ“‹ ProgramRepository" as ProgramRepo
participant "ğŸ—„ï¸ SqlServerConnection" as Database
participant "ğŸ“Š Database" as DB

' ========================================
' MAIN FLOW - Customer Evaluation
' ========================================

== ğŸš€ User cháº¡y á»©ng dá»¥ng ==
User -> CLI: py src/main.py
activate CLI

CLI -> CLI: run_interactive()
note right: Hiá»ƒn thá»‹ menu cho user

== ğŸ“ User nháº­p thÃ´ng tin ==
User -> CLI: Nháº­p yyyymm=202509, customer_code=CUST001, program_code=PROG001
CLI -> CLI: validate_input()

== ğŸ”„ Gá»i Use Case ==
CLI -> UseCase: execute(yyyymm=202509, customer_code=CUST001, program_code=PROG001)
activate UseCase

UseCase -> UseCase: validate_parameters()
note right: Kiá»ƒm tra tham sá»‘ Ä‘áº§u vÃ o

== ğŸ§  Gá»i Domain Service ==
UseCase -> DomainService: evaluate_customer(yyyymm=202509, customer_code=CUST001, program_code=PROG001)
activate DomainService

== ğŸ“ BÆ°á»›c 1: Kiá»ƒm tra Ä‘Äƒng kÃ½ ==
DomainService -> RegistrationRepo: get_registrations(yyyymm=202509, customer_code=CUST001, active_only=False)
activate RegistrationRepo

RegistrationRepo -> Database: get_connection()
activate Database
Database -> DB: SELECT * FROM register WHERE yyyymm=202509 AND customer_code='CUST001'
DB --> Database: Registration data
Database --> RegistrationRepo: List[Registration]
deactivate Database

RegistrationRepo --> DomainService: List[Registration]
deactivate RegistrationRepo

DomainService -> DomainService: TÃ¬m Ä‘Äƒng kÃ½ cho PROG001
note right: TÃ¬m registration cÃ³ program_code = 'PROG001'

alt KhÃ´ng tÃ¬m tháº¥y Ä‘Äƒng kÃ½
  DomainService --> UseCase: CustomerEvaluationResult(meets_criteria=False, failed_conditions=["NOT_REGISTERED"])
  UseCase --> CLI: Error result
  CLI --> User: âŒ KhÃ¡ch hÃ ng chÆ°a Ä‘Äƒng kÃ½ chÆ°Æ¡ng trÃ¬nh
else TÃ¬m tháº¥y Ä‘Äƒng kÃ½
  == ğŸ“‹ BÆ°á»›c 2: Láº¥y cáº¥u hÃ¬nh chÆ°Æ¡ng trÃ¬nh ==
  DomainService -> ProgramRepo: get_register_item(yyyymm=202509, program_code=PROG001, display_type=KE_3_O)
  activate ProgramRepo
  
  ProgramRepo -> Database: get_connection()
  activate Database
  Database -> DB: SELECT * FROM register_item WHERE yyyymm=202509 AND program_code='PROG001' AND item='KE_3_O'
  DB --> Database: RegisterItem data
  Database --> ProgramRepo: RegisterItem
  deactivate Database
  
  ProgramRepo --> DomainService: RegisterItem(type_code=TYPE_BEVERAGE)
  deactivate ProgramRepo
  
  == ğŸ“Š BÆ°á»›c 3: Láº¥y condition groups ==
  DomainService -> EvaluationRepo: get_condition_groups(yyyymm=202509, program_code=PROG001, type_code=TYPE_BEVERAGE)
  activate EvaluationRepo
  
  EvaluationRepo -> Database: get_connection()
  activate Database
  Database -> DB: SELECT * FROM condition_group WHERE yyyymm=202509 AND program_code='PROG001' AND type_code='TYPE_BEVERAGE'
  DB --> Database: ConditionGroup data
  Database --> EvaluationRepo: List[ConditionGroup]
  deactivate Database
  
  EvaluationRepo --> DomainService: List[ConditionGroup]
  deactivate EvaluationRepo
  
  == ğŸ“¸ BÆ°á»›c 4: Láº¥y káº¿t quáº£ audit ==
  DomainService -> EvaluationRepo: get_audit_results(yyyymm=202509, customer_code=CUST001)
  activate EvaluationRepo
  
  EvaluationRepo -> Database: get_connection()
  activate Database
  Database -> DB: SELECT * FROM audit_picture WHERE yyyymm=202509 AND customer_code='CUST001'
  DB --> Database: AuditPicture data
  Database --> EvaluationRepo: List[AuditPicture]
  deactivate Database
  
  EvaluationRepo --> DomainService: List[AuditPicture]
  deactivate EvaluationRepo
  
  == ğŸ¯ BÆ°á»›c 5: ÄÃ¡nh giÃ¡ theo tá»«ng group ==
  loop Cho má»—i ConditionGroup
    DomainService -> EvaluationRepo: get_condition_items_by_group(yyyymm=202509, program_code=PROG001, group=1)
    activate EvaluationRepo
    
    EvaluationRepo -> Database: get_connection()
    activate Database
    Database -> DB: SELECT * FROM condition_item WHERE yyyymm=202509 AND program_code='PROG001' AND group=1
    DB --> Database: ConditionItem data
    Database --> EvaluationRepo: List[ConditionItem]
    deactivate Database
    
    EvaluationRepo --> DomainService: List[ConditionItem]
    deactivate EvaluationRepo
    
    DomainService -> DomainService: ÄÃ¡nh giÃ¡ tá»«ng ConditionItem
    note right: So sÃ¡nh audit_value vs condition_min_value
    note right: TÃ­nh group_score vÃ  so sÃ¡nh vá»›i group_point
  end
  
  == ğŸ“Š BÆ°á»›c 6: XÃ¡c Ä‘á»‹nh káº¿t quáº£ cuá»‘i cÃ¹ng ==
  DomainService -> DomainService: TÃ­nh tá»•ng Ä‘iá»ƒm vÃ  xÃ¡c Ä‘á»‹nh meets_criteria
  note right: meets_criteria = True náº¿u Táº¤T Cáº¢ groups Ä‘á»u PASS
  
  DomainService -> EvaluationRepo: save_evaluation_result(result)
  activate EvaluationRepo
  
  EvaluationRepo -> Database: get_connection()
  activate Database
  Database -> DB: INSERT INTO evaluation_result (...)
  DB --> Database: Success
  Database --> EvaluationRepo: Success
  deactivate Database
  
  EvaluationRepo --> DomainService: Success
  deactivate EvaluationRepo
  
  DomainService --> UseCase: CustomerEvaluationResult
  deactivate DomainService
end

== ğŸ“‹ Tráº£ káº¿t quáº£ vá» Use Case ==
UseCase -> UseCase: Format result as dictionary
UseCase --> CLI: Dictionary result
deactivate UseCase

== ğŸ–¥ï¸ Hiá»ƒn thá»‹ káº¿t quáº£ cho User ==
CLI -> CLI: _display_result(result)
CLI --> User: ğŸ“Š Káº¿t quáº£ Ä‘Ã¡nh giÃ¡ chi tiáº¿t
deactivate CLI

' ========================================
' ERROR HANDLING FLOW
' ========================================
== âŒ Xá»­ lÃ½ lá»—i ==
note over User, DB
  ğŸ”§ ERROR HANDLING:
  =================
  
  Náº¿u cÃ³ lá»—i xáº£y ra á»Ÿ báº¥t ká»³ bÆ°á»›c nÃ o:
  1. Database connection failed â†’ Hiá»ƒn thá»‹ lá»—i káº¿t ná»‘i
  2. Repository method failed â†’ Hiá»ƒn thá»‹ lá»—i dá»¯ liá»‡u
  3. Domain service failed â†’ Hiá»ƒn thá»‹ lá»—i nghiá»‡p vá»¥
  4. Use case failed â†’ Hiá»ƒn thá»‹ lá»—i á»©ng dá»¥ng
  5. CLI failed â†’ Hiá»ƒn thá»‹ lá»—i giao diá»‡n
  
  ğŸ¯ Lá»¢I ÃCH:
  - Má»—i layer xá»­ lÃ½ lá»—i phÃ¹ há»£p vá»›i trÃ¡ch nhiá»‡m
  - User nháº­n Ä‘Æ°á»£c thÃ´ng bÃ¡o lá»—i rÃµ rÃ ng
  - Dá»… dÃ ng debug vÃ  fix lá»—i
end note

' ========================================
' TESTING FLOW
' ========================================
== ğŸ§ª Testing Flow ==
note over User, DB
  ğŸ§ª TESTING STRATEGY:
  ===================
  
  UNIT TESTS:
  - Test Domain Entities: Táº¡o objects vÃ  test business logic
  - Test Domain Services: Mock repositories vÃ  test business logic
  - Test Use Cases: Mock services vÃ  test orchestration
  
  INTEGRATION TESTS:
  - Test Repository Implementations: Sá»­ dá»¥ng test database
  - Test Database Connection: Kiá»ƒm tra káº¿t ná»‘i thá»±c táº¿
  
  END-TO-END TESTS:
  - Test Complete Workflow: Tá»« CLI Ä‘áº¿n Database
  - Test Error Scenarios: CÃ¡c trÆ°á»ng há»£p lá»—i khÃ¡c nhau
  
  ğŸ¯ Lá»¢I ÃCH:
  - Má»—i layer cÃ³ thá»ƒ test Ä‘á»™c láº­p
  - Dá»… dÃ ng mock dependencies
  - Test coverage cao
  - PhÃ¡t hiá»‡n lá»—i sá»›m
end note

@enduml
